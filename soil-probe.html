<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SoilProbe IoT Monitor - Hardini</title>
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üå±</text></svg>">
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">

    <!-- Supabase CDN (for authentication) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Firebase CDN (for database) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

</head>

<body>
    <header>
        <nav>
            <div class="logo">HARDINI üå±</div>
            <div class="nav-links">
                <a href="index.html">üè† HOME</a>
                <a href="supply-chain.html">üîÑ SUPPLY CHAIN</a>
                <a href="connect.html">ü§ù CONNECT</a>
                <a href="reels.html">üé• REELS</a>
                <a href="soil-probe.html" class="active">üå± SOILPROBE</a>
                <button class="auth-toggle-btn" id="authToggleBtn" onclick="toggleAuth()">üîê LOGIN</button>
                <div class="user-menu" id="userMenu" style="display: none;">
                    <div class="user-info clickable" onclick="openProfile()" style="cursor: pointer;"
                        title="Click to open profile">
                        <span id="userAvatar">üë®‚Äçüåæ</span>
                        <span id="userName">User</span>
                    </div>
                    <div class="user-dropdown">
                        <button onclick="openProfile()">üë§ Profile</button>
                        <button onclick="logout()">üö™ Logout</button>
                    </div>
                </div>
            </div>
        </nav>
    </header>

    <main>
        <section class="soil-probe-hero">
            <div class="hero-content">
                <h1>üå± SoilProbe IoT Monitor</h1>
                <h2>Real-time Soil & Environmental Monitoring</h2>
                <p>Precision farming with IoT sensors for optimal crop management and yield optimization</p>
                <div class="hero-stats">
                    <div class="stat-item">
                        <span class="stat-number">500+</span>
                        <span class="stat-label">Active Sensors</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number">24/7</span>
                        <span class="stat-label">Monitoring</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number">99.9%</span>
                        <span class="stat-label">Uptime</span>
                    </div>
                </div>
            </div>
        </section>

        <section class="monitoring-dashboard">
            <div class="dashboard-container">
                <div class="dashboard-header">
                    <h2>üìä Live Field Monitoring</h2>
                    <div class="dashboard-controls">
                        <select id="fieldSelect" class="field-select">
                            <option value="">Select Field</option>
                            <option value="field1">Field 1 - Wheat Crop</option>
                            <option value="field2">Field 2 - Rice Crop</option>
                            <option value="field3">Field 3 - Cotton Crop</option>
                        </select>
                        <button class="refresh-btn" onclick="refreshData()">üîÑ Refresh</button>
                    </div>
                </div>

                <!-- Real-time Metrics Cards -->
                <div class="metrics-grid">
                    <div class="metric-card soil-temp">
                        <div class="metric-header">
                            <div class="metric-icon">üå°Ô∏è</div>
                            <div class="metric-info">
                                <h3>Soil Temperature</h3>
                                <span class="metric-unit">¬∞C</span>
                            </div>
                        </div>
                        <div class="metric-value">
                            <span id="soilTempValue">--</span>
                            <span class="metric-trend" id="soilTempTrend">‚ÜóÔ∏è +0.5¬∞C</span>
                        </div>
                        <div class="metric-status">
                            <span class="status-indicator" id="soilTempStatus">Optimal</span>
                        </div>
                    </div>

                    <div class="metric-card soil-moisture">
                        <div class="metric-header">
                            <div class="metric-icon">üíß</div>
                            <div class="metric-info">
                                <h3>Soil Moisture</h3>
                                <span class="metric-unit">%</span>
                            </div>
                        </div>
                        <div class="metric-value">
                            <span id="soilMoistureValue">--</span>
                            <span class="metric-trend" id="soilMoistureTrend">‚ÜòÔ∏è -2.1%</span>
                        </div>
                        <div class="metric-status">
                            <span class="status-indicator" id="soilMoistureStatus">Low</span>
                        </div>
                    </div>

                    <div class="metric-card ambient-temp">
                        <div class="metric-header">
                            <div class="metric-icon">üå§Ô∏è</div>
                            <div class="metric-info">
                                <h3>Ambient Temperature</h3>
                                <span class="metric-unit">¬∞C</span>
                            </div>
                        </div>
                        <div class="metric-value">
                            <span id="ambientTempValue">--</span>
                            <span class="metric-trend" id="ambientTempTrend">‚ÜóÔ∏è +1.2¬∞C</span>
                        </div>
                        <div class="metric-status">
                            <span class="status-indicator" id="ambientTempStatus">Normal</span>
                        </div>
                    </div>

                    <div class="metric-card ambient-humidity">
                        <div class="metric-header">
                            <div class="metric-icon">üí®</div>
                            <div class="metric-info">
                                <h3>Ambient Humidity</h3>
                                <span class="metric-unit">%</span>
                            </div>
                        </div>
                        <div class="metric-value">
                            <span id="ambientHumidityValue">--</span>
                            <span class="metric-trend" id="ambientHumidityTrend">‚ÜòÔ∏è -3.5%</span>
                        </div>
                        <div class="metric-status">
                            <span class="status-indicator" id="ambientHumidityStatus">Optimal</span>
                        </div>
                    </div>
                </div>

                <!-- Charts Section -->
                <div class="charts-section">
                    <div class="chart-container">
                        <h3>üìà 24-Hour Trends</h3>
                        <canvas id="trendsChart"></canvas>
                    </div>

                    <div class="chart-container">
                        <h3>üå± Soil Health Analysis</h3>
                        <canvas id="soilHealthChart"></canvas>
                    </div>
                </div>


            </div>
        </section>

        <!-- How It Works Section -->
        <section class="how-it-works">
            <div class="container">
                <h2>üî¨ How SoilProbe Works</h2>
                <div class="steps-grid">
                    <div class="step-card">
                        <div class="step-number">1</div>
                        <div class="step-icon">üå±</div>
                        <h3>Install Sensors</h3>
                        <p>Place IoT sensors in your farmland at optimal depths for comprehensive monitoring</p>
                    </div>
                    <div class="step-card">
                        <div class="step-number">2</div>
                        <div class="step-icon">üì°</div>
                        <h3>Real-time Data</h3>
                        <p>Sensors continuously collect soil temperature, moisture, and environmental data</p>
                    </div>
                    <div class="step-card">
                        <div class="step-number">3</div>
                        <div class="step-icon">üìä</div>
                        <h3>AI Analysis</h3>
                        <p>Advanced algorithms analyze data patterns and provide actionable insights</p>
                    </div>
                    <div class="step-card">
                        <div class="step-number">4</div>
                        <div class="step-icon">üöÄ</div>
                        <h3>Optimize Yield</h3>
                        <p>Receive recommendations for irrigation, fertilization, and crop management</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Features Section -->
        <section class="features-section">
            <div class="container">
                <h2>‚ú® Key Features</h2>
                <div class="features-grid">
                    <div class="feature-item">
                        <div class="feature-icon">üå°Ô∏è</div>
                        <h3>Multi-Parameter Monitoring</h3>
                        <p>Track soil temperature, moisture, pH levels, and ambient conditions simultaneously</p>
                    </div>
                    <div class="feature-item">
                        <div class="feature-icon">üì±</div>
                        <h3>Mobile Alerts</h3>
                        <p>Get instant notifications when conditions require attention</p>
                    </div>
                    <div class="feature-item">
                        <div class="feature-icon">üìä</div>
                        <h3>Data Analytics</h3>
                        <p>Historical data analysis and predictive insights for better planning</p>
                    </div>
                    <div class="feature-item">
                        <div class="feature-icon">üîã</div>
                        <h3>Long Battery Life</h3>
                        <p>Solar-powered sensors with up to 2 years of battery life</p>
                    </div>
                    <div class="feature-item">
                        <div class="feature-icon">üåê</div>
                        <h3>Cloud Integration</h3>
                        <p>Access your data anywhere with secure cloud storage</p>
                    </div>
                    <div class="feature-item">
                        <div class="feature-icon">ü§ñ</div>
                        <h3>AI Recommendations</h3>
                        <p>Machine learning algorithms provide personalized farming advice</p>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <div class="footer-section">
                <h3>About Hardini</h3>
                <p>Empowering agriculture through innovative technology solutions and sustainable farming practices.</p>
            </div>

            <div class="footer-section">
                <h3>Quick Links</h3>
                <ul>
                    <li><a href="index.html">Home</a></li>
                    <li><a href="supply-chain.html">Supply Chain</a></li>
                    <li><a href="connect.html">Connect</a></li>
                    <li><a href="reels.html">Reels</a></li>
                    <li><a href="soil-probe.html">SoilProbe</a></li>
                </ul>
            </div>

            <div class="footer-section">
                <h3>Contact</h3>
                <p>üìß info@hardini.com</p>
                <p>üì± +91 123 456 7890</p>
            </div>
        </div>

        <div class="footer-bottom">
            <p>&copy; 2024 Hardini Technologies. All rights reserved.</p>
        </div>
    </footer>

    <!-- Authentication Modal -->
    <div id="authModal" class="auth-modal">
        <div class="auth-modal-content">
            <span class="close-modal" onclick="document.getElementById('authModal').style.display='none'">&times;</span>

            <!-- Login Tab -->
            <div id="loginTab" class="auth-tab active">
                <h2>üîê Login to Hardini</h2>
                <form id="loginForm" class="auth-form">
                    <div class="form-group">
                        <label for="loginEmail">Email Address</label>
                        <input type="email" id="loginEmail" placeholder="Enter your email" required>
                    </div>
                    <div class="form-group">
                        <label for="loginPassword">Password</label>
                        <input type="password" id="loginPassword" placeholder="Enter your password" required>
                    </div>
                    <div class="form-options">
                        <label class="remember-me">
                            <input type="checkbox" id="rememberMe"> Remember me
                        </label>
                        <a href="#" class="forgot-password" onclick="showForgotPassword()">Forgot password?</a>
                    </div>
                    <button type="submit" class="auth-btn">Login</button>
                </form>
                <div class="auth-divider">
                    <span>or</span>
                </div>
                <div class="social-login">
                    <button class="social-btn google-btn" onclick="loginWithGoogle()">
                        <span class="social-icon">üåê</span>
                        Continue with Google
                    </button>
                </div>
                <div class="auth-switch">
                    Don't have an account? <a href="#" onclick="switchToSignup()">Sign up</a>
                </div>
            </div>

            <!-- Signup Tab -->
            <div id="signupTab" class="auth-tab">
                <h2>üå± Join Hardini</h2>
                <form id="signupForm" class="auth-form">
                    <div class="form-group">
                        <label for="signupName">Full Name</label>
                        <input type="text" id="signupName" placeholder="Enter your full name" required>
                    </div>
                    <div class="form-group">
                        <label for="signupEmail">Email Address</label>
                        <input type="email" id="signupEmail" placeholder="Enter your email" required>
                    </div>
                    <div class="form-group">
                        <label for="signupPassword">Password</label>
                        <input type="password" id="signupPassword" placeholder="Create a password" required>
                        <span class="password-hint">Must be at least 8 characters</span>
                    </div>
                    <div class="form-group">
                        <label for="signupConfirmPassword">Confirm Password</label>
                        <input type="password" id="signupConfirmPassword" placeholder="Confirm your password" required>
                    </div>
                    <div class="terms-agreement">
                        <label class="terms-checkbox">
                            <input type="checkbox" id="agreeTerms" required>
                            I agree to the <a href="#" onclick="showTerms()">Terms of Service</a> and <a href="#"
                                onclick="showPrivacy()">Privacy Policy</a>
                        </label>
                    </div>
                    <button type="submit" class="auth-btn">Create Account</button>
                </form>
                <div class="auth-divider">
                    <span>or</span>
                </div>
                <div class="social-login">
                    <button class="social-btn google-btn" onclick="signupWithGoogle()">
                        <span class="social-icon">üåê</span>
                        Continue with Google
                    </button>
                </div>
                <div class="auth-switch">
                    Already have an account? <a href="#" onclick="switchToLogin()">Login</a>
                </div>
            </div>

            <!-- Profile Tab -->
            <div id="profileTab" class="auth-tab">
                <div class="profile-info">
                    <div class="profile-avatar" id="modalUserAvatar">üë®‚Äçüåæ</div>
                    <div class="profile-details">
                        <h3 id="modalUserName">User Name</h3>
                        <p id="modalUserEmail">user@example.com</p>
                    </div>
                </div>
                <div class="profile-actions">
                    <button class="profile-btn" onclick="editProfile()">
                        <span class="action-icon">‚úèÔ∏è</span>
                        Edit Profile
                    </button>
                    <button class="profile-btn" onclick="viewOrders()">
                        <span class="action-icon">üì¶</span>
                        My Orders
                    </button>
                </div>
                <div class="profile-actions">
                    <button class="profile-btn" onclick="openSettings()">
                        <span class="action-icon">‚öôÔ∏è</span>
                        Settings
                    </button>
                    <button class="profile-btn" onclick="logout()">
                        <span class="action-icon">üö™</span>
                        Logout
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Supabase Authentication Script -->
    <script>
        // ============================================
        // ESSENTIAL UI FUNCTIONS (Must be defined first)
        // ============================================

        function toggleAuth() {
            const authModal = document.getElementById('authModal');
            if (authModal) {
                authModal.style.display = 'flex';
                switchToLogin();
            }
        }

        function openProfile() {
            const authModal = document.getElementById('authModal');
            if (authModal) {
                authModal.style.display = 'flex';
                showProfileTab();
            }
        }

        async function logout() {
            try {
                if (supabaseClient) {
                    await supabaseClient.auth.signOut();
                }
            } catch (error) {
                console.error('Logout error:', error);
            }
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <span class="notification-icon">${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ÑπÔ∏è'}</span>
                <span class="notification-text">${message}</span>
            `;
            document.body.appendChild(notification);
            setTimeout(() => notification.classList.add('show'), 100);
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 4000);
        }

        // ============================================
        // SUPABASE CONFIGURATION
        // ============================================
        const SUPABASE_URL = 'https://aahedprzvceldzcmmvpp.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFhaGVkcHJ6dmNlbGR6Y21tdnBwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE2NTg5NzAsImV4cCI6MjA3NzIzNDk3MH0.z98v917ye2PU76gfk4cqfTGUGNMfPKqTJdBgkFkyVDo';

        let supabaseClient = null;
        try {
            if (window.supabase && window.supabase.createClient) {
                supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
                    realtime: { params: { eventsPerSecond: 5 } }
                });
            }
        } catch (error) {
            console.error('Failed to initialize Supabase:', error);
        }

        let currentUser = null;

        document.addEventListener('DOMContentLoaded', async () => {
            if (supabaseClient) {
                const { data: { user }, error } = await supabaseClient.auth.getUser();
                if (user && !error) {
                    currentUser = user;
                    updateUIForLoggedInUser(user);
                }
                supabaseClient.auth.onAuthStateChange(async (event, session) => {
                    if (event === 'SIGNED_IN' && session?.user) {
                        currentUser = session.user;
                        updateUIForLoggedInUser(session.user);
                    } else if (event === 'SIGNED_OUT') {
                        currentUser = null;
                        updateUIForLoggedOutUser();
                    }
                });
            }
            initializeSoilProbe();
        });

        // Update UI for logged in user
        function updateUIForLoggedInUser(user) {
            const authToggleBtn = document.getElementById('authToggleBtn');
            const userMenu = document.getElementById('userMenu');

            if (authToggleBtn) authToggleBtn.style.display = 'none';
            if (userMenu) userMenu.style.display = 'flex';

            // Update user info
            const userAvatar = document.getElementById('userAvatar');
            const userName = document.getElementById('userName');

            if (userAvatar) userAvatar.textContent = getUserEmoji(user.email);
            if (userName) userName.textContent = user.user_metadata?.full_name || user.email.split('@')[0];
        }

        // Update UI for logged out user
        function updateUIForLoggedOutUser() {
            const authToggleBtn = document.getElementById('authToggleBtn');
            const userMenu = document.getElementById('userMenu');

            if (authToggleBtn) authToggleBtn.style.display = 'inline-block';
            if (userMenu) userMenu.style.display = 'none';
        }

        // Authentication functions
        function toggleAuth() {
            const authModal = document.getElementById('authModal');
            if (authModal) {
                authModal.style.display = 'flex';
            }
        }

        function openProfile() {
            const authModal = document.getElementById('authModal');
            if (authModal) {
                authModal.style.display = 'flex';
                showProfileTab();
            }
        }

        async function logout() {
            try {
                const { error } = await supabaseClient.auth.signOut();
                if (error) throw error;
            } catch (error) {
                console.error('Logout error:', error);
            }
        }

        // Utility functions
        function getUserEmoji(email) {
            const letters = (email + 'default').substring(0, 2).toLowerCase();
            const emojiOptions = ['üë®‚Äçüåæ', 'üë©‚Äçüåæ', 'üåæ', 'üå±', 'üöú', 'üåΩ', 'üçé', 'ü•ï'];
            const index = letters.charCodeAt(0) + letters.charCodeAt(1);
            return emojiOptions[index % emojiOptions.length];
        }

        // Enhanced notification function
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <span class="notification-icon">
                    ${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è'}
                </span>
                <span class="notification-text">${message}</span>
            `;
            document.body.appendChild(notification);

            setTimeout(() => notification.classList.add('show'), 100);
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 4000);
        }

        // Modal tab switching functions
        function switchToLogin() {
            showAuthTab('loginTab');
        }

        function switchToSignup() {
            showAuthTab('signupTab');
        }

        function showProfileTab() {
            showAuthTab('profileTab');
            // Update profile info if user is logged in
            if (currentUser) {
                document.getElementById('modalUserName').textContent = currentUser.user_metadata?.full_name || currentUser.email.split('@')[0];
                document.getElementById('modalUserEmail').textContent = currentUser.email;
                document.getElementById('modalUserAvatar').textContent = getUserEmoji(currentUser.email);
            }
        }

        function showAuthTab(tabId) {
            // Hide all tabs
            const tabs = document.querySelectorAll('.auth-tab');
            tabs.forEach(tab => tab.classList.remove('active'));

            // Show selected tab
            const selectedTab = document.getElementById(tabId);
            if (selectedTab) {
                selectedTab.classList.add('active');
            }
        }

        // Form handling functions
        document.addEventListener('DOMContentLoaded', () => {
            // Login form submission
            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
                loginForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await handleLogin();
                });
            }

            // Signup form submission
            const signupForm = document.getElementById('signupForm');
            if (signupForm) {
                signupForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await handleSignup();
                });
            }

            // Close modal when clicking outside
            const authModal = document.getElementById('authModal');
            if (authModal) {
                authModal.addEventListener('click', (e) => {
                    if (e.target === authModal) {
                        authModal.style.display = 'none';
                    }
                });
            }
        });

        // Login handler
        async function handleLogin() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const rememberMe = document.getElementById('rememberMe').checked;

            try {
                const { data, error } = await supabaseClient.auth.signInWithPassword({
                    email: email,
                    password: password
                });

                if (error) throw error;

                showNotification('Login successful! Welcome back.', 'success');
                document.getElementById('authModal').style.display = 'none';

                // Reset form
                document.getElementById('loginForm').reset();

            } catch (error) {
                console.error('Login error:', error);
                showNotification(error.message || 'Login failed. Please try again.', 'error');
            }
        }

        // Signup handler
        async function handleSignup() {
            const name = document.getElementById('signupName').value;
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const confirmPassword = document.getElementById('signupConfirmPassword').value;
            const agreeTerms = document.getElementById('agreeTerms').checked;

            // Validation
            if (password !== confirmPassword) {
                showNotification('Passwords do not match.', 'error');
                return;
            }

            if (password.length < 8) {
                showNotification('Password must be at least 8 characters long.', 'error');
                return;
            }

            if (!agreeTerms) {
                showNotification('Please agree to the Terms of Service and Privacy Policy.', 'error');
                return;
            }

            try {
                const { data, error } = await supabaseClient.auth.signUp({
                    email: email,
                    password: password,
                    options: {
                        data: {
                            full_name: name
                        }
                    }
                });

                if (error) throw error;

                showNotification('Account created successfully! Please check your email to verify your account.', 'success');
                document.getElementById('authModal').style.display = 'none';

                // Reset form
                document.getElementById('signupForm').reset();

            } catch (error) {
                console.error('Signup error:', error);
                showNotification(error.message || 'Signup failed. Please try again.', 'error');
            }
        }

        // Social login functions (placeholders)
        async function loginWithGoogle() {
            try {
                const { data, error } = await supabaseClient.auth.signInWithOAuth({
                    provider: 'google',
                    options: {
                        redirectTo: window.location.origin
                    }
                });

                if (error) throw error;

            } catch (error) {
                console.error('Google login error:', error);
                showNotification('Google login failed. Please try again.', 'error');
            }
        }

        async function signupWithGoogle() {
            // Same as login with Google
            await loginWithGoogle();
        }

        // Profile functions (placeholders)
        function editProfile() {
            showNotification('Profile editing feature coming soon!', 'info');
        }

        function viewOrders() {
            showNotification('Orders feature coming soon!', 'info');
        }

        function openSettings() {
            showNotification('Settings feature coming soon!', 'info');
        }

        // Utility functions
        function showForgotPassword() {
            showNotification('Password reset feature coming soon! Please contact support.', 'info');
        }

        function showTerms() {
            showNotification('Terms of Service will be displayed here.', 'info');
        }

        function showPrivacy() {
            showNotification('Privacy Policy will be displayed here.', 'info');
        }
    </script>

    <!-- Firebase Configuration and SoilProbe IoT Functionality -->
    <script>
        // Firebase Configuration
        const firebaseConfig = {
            databaseURL: 'https://hardini-d2114-default-rtdb.asia-southeast1.firebasedatabase.app/'
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const firebaseDb = firebase.database();

        // SoilProbe IoT Monitoring System
        let currentField = '';
        let sensorData = {};
        let previousSensorData = {}; // Store previous readings for trend calculation
        let trendsChart = null;
        let soilHealthChart = null;
        let realtimeListeners = []; // Store listeners for cleanup

        // Initialize SoilProbe functionality
        function initializeSoilProbe() {
            // Set up field selection
            const fieldSelect = document.getElementById('fieldSelect');
            fieldSelect.addEventListener('change', (e) => {
                currentField = e.target.value;
                if (currentField) {
                    loadFieldData(currentField);
                }
            });

            // Initialize charts
            initializeCharts();

            // Load initial real data from Firebase
            loadRealData();
        }

        // Initialize Chart.js charts
        function initializeCharts() {
            // Trends Chart
            const trendsCtx = document.getElementById('trendsChart').getContext('2d');
            trendsChart = new Chart(trendsCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Soil Temperature (¬∞C)',
                        data: [],
                        borderColor: '#ff6b35',
                        backgroundColor: 'rgba(255, 107, 53, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'Soil Moisture (%)',
                        data: [],
                        borderColor: '#4a90e2',
                        backgroundColor: 'rgba(74, 144, 226, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false
                        }
                    }
                }
            });

            // Soil Health Chart (will be updated with real data)
            const soilHealthCtx = document.getElementById('soilHealthChart').getContext('2d');
            soilHealthChart = new Chart(soilHealthCtx, {
                type: 'radar',
                data: {
                    labels: ['Temperature', 'Moisture', 'pH Level', 'Nutrients', 'Aeration', 'Drainage'],
                    datasets: [{
                        label: 'Current Health',
                        data: [0, 0, 0, 0, 0, 0], // Will be updated with real data
                        borderColor: '#2ecc71',
                        backgroundColor: 'rgba(46, 204, 113, 0.2)',
                        pointBackgroundColor: '#2ecc71'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
        }

        // Load real data from API (using backend API instead of direct Firebase)
        async function loadRealData() {
            try {
                // Check if user is logged in
                if (!currentUser) {
                    showNotification('Please login to view your sensor data', 'warning');
                    return;
                }

                // Fetch latest soil readings from backend API (for device 'soilprobe1')
                const response = await fetch(`https://backend-iota-livid-46.vercel.app/api/soil-readings/soilprobe1?limit=1&user_uid=${currentUser.id}`);
                const data = await response.json();

                if (data.success && data.data && data.data.length > 0) {
                    const latestReading = data.data[0];
                    sensorData = {
                        soil_temp_c: latestReading.soil_temp_c || 0,
                        soil_moist_pct: latestReading.soil_moist_pct || 0,
                        ambient_temp_c: latestReading.ambient_temp_c || 0,
                        ambient_humidity_pct: latestReading.ambient_humidity_pct || 0,
                        rssi: latestReading.rssi || 0,
                        device_id: latestReading.device_id,
                        created_at: latestReading.created_at
                    };

                    updateDashboard(sensorData);
                    showNotification('Sensor data loaded successfully', 'success');
                } else {
                    showNotification('No sensor data available', 'warning');
                }

                // Load historical data for trends chart
                await loadHistoricalData();

                // Set up real-time polling
                setupRealtimePolling();

            } catch (error) {
                console.error('Error loading real data:', error);
                showNotification('Failed to load sensor data', 'error');
            }
        }

        // Set up real-time polling for live updates
        function setupRealtimePolling() {
            // Poll for new data every 30 seconds
            setInterval(async () => {
                try {
                    if (!currentUser) return; // Don't poll if user not logged in

                    const response = await fetch(`https://backend-iota-livid-46.vercel.app/api/soil-readings/soilprobe1?limit=1&user_uid=${currentUser.id}`);
                    const data = await response.json();

                    if (data.success && data.data && data.data.length > 0) {
                        const latestReading = data.data[0];

                        // Check if this is newer data than what we have
                        const currentTime = new Date(sensorData.created_at || 0);
                        const newTime = new Date(latestReading.created_at);

                        if (newTime > currentTime) {
                            console.log('New soil reading received via polling:', latestReading);

                            // Update sensor data with real-time values
                            sensorData = {
                                soil_temp_c: latestReading.soil_temp_c || 0,
                                soil_moist_pct: latestReading.soil_moist_pct || 0,
                                ambient_temp_c: latestReading.ambient_temp_c || 0,
                                ambient_humidity_pct: latestReading.ambient_humidity_pct || 0,
                                rssi: latestReading.rssi || 0,
                                device_id: latestReading.device_id,
                                created_at: latestReading.created_at
                            };

                            updateDashboard(sensorData);
                            showNotification('üì° Live sensor data updated!', 'success');
                        }
                    }
                } catch (error) {
                    console.error('Error polling for new data:', error);
                }
            }, 30000); // Poll every 30 seconds

            console.log('Real-time polling set up for soil readings');
        }

        // Load historical data for trends chart
        async function loadHistoricalData() {
            try {
                if (!currentUser) return; // Don't load if user not logged in

                // Fetch historical data from backend API
                const response = await fetch(`https://backend-iota-livid-46.vercel.app/api/soil-readings/soilprobe1?limit=24&user_uid=${currentUser.id}`);
                const data = await response.json();

                if (data.success && data.data && data.data.length > 0) {
                    // Data is already sorted by created_at descending, so reverse for chart
                    const historicalData = data.data.reverse();

                    if (historicalData.length > 0) {
                        const labels = [];
                        const tempData = [];
                        const moistureData = [];

                        historicalData.forEach(reading => {
                            const time = new Date(reading.created_at);
                            labels.push(time.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }));
                            tempData.push(reading.soil_temp_c || 0);
                            moistureData.push(reading.soil_moist_pct || 0);
                        });

                        trendsChart.data.labels = labels;
                        trendsChart.data.datasets[0].data = tempData;
                        trendsChart.data.datasets[1].data = moistureData;
                        trendsChart.update();
                    }
                }

            } catch (error) {
                console.error('Error loading historical data:', error);
            }
        }

        // Load field-specific data (using backend API)
        async function loadFieldData(fieldId) {
            try {
                if (!currentUser) {
                    showNotification('Please login to view field data', 'warning');
                    return;
                }

                // Fetch latest data for the selected field/device from backend API
                const response = await fetch(`https://backend-iota-livid-46.vercel.app/api/soil-readings/${fieldId}?limit=1&user_uid=${currentUser.id}`);
                const data = await response.json();

                if (data.success && data.data && data.data.length > 0) {
                    const latestReading = data.data[0];
                    sensorData = {
                        soil_temp_c: latestReading.soil_temp_c || 0,
                        soil_moist_pct: latestReading.soil_moist_pct || 0,
                        ambient_temp_c: latestReading.ambient_temp_c || 0,
                        ambient_humidity_pct: latestReading.ambient_humidity_pct || 0,
                        rssi: latestReading.rssi || 0,
                        device_id: latestReading.device_id,
                        created_at: latestReading.created_at
                    };

                    updateDashboard(sensorData);
                    showNotification(`Loaded real-time data for ${fieldId}`, 'success');
                } else {
                    showNotification(`No data available for ${fieldId}`, 'warning');
                }

            } catch (error) {
                console.error('Error loading field data:', error);
                showNotification('Failed to load field data', 'error');
            }
        }



        // Update trend indicators with real calculated values
        function updateTrendIndicators(currentData) {
            // Calculate trends based on difference from previous reading
            const calculateTrend = (current, previous, unit = '') => {
                if (!previous || previous === 0) {
                    return `--`; // No previous data to compare
                }

                const difference = current - previous;
                const absDifference = Math.abs(difference);

                if (absDifference < 0.1) {
                    return `‚Üí 0.0${unit}`; // No significant change
                }

                const sign = difference > 0 ? '+' : '';
                const arrow = difference > 0 ? '‚ÜóÔ∏è' : '‚ÜòÔ∏è';

                // Format based on the magnitude
                let formattedValue;
                if (absDifference >= 10) {
                    formattedValue = difference.toFixed(1);
                } else if (absDifference >= 1) {
                    formattedValue = difference.toFixed(1);
                } else {
                    formattedValue = difference.toFixed(2);
                }

                return `${arrow} ${sign}${formattedValue}${unit}`;
            };

            // Update each trend indicator
            document.getElementById('soilTempTrend').textContent =
                calculateTrend(currentData.soil_temp_c, previousSensorData.soil_temp_c, '¬∞C');

            document.getElementById('soilMoistureTrend').textContent =
                calculateTrend(currentData.soil_moist_pct, previousSensorData.soil_moist_pct, '%');

            document.getElementById('ambientTempTrend').textContent =
                calculateTrend(currentData.ambient_temp_c, previousSensorData.ambient_temp_c, '¬∞C');

            document.getElementById('ambientHumidityTrend').textContent =
                calculateTrend(currentData.ambient_humidity_pct, previousSensorData.ambient_humidity_pct, '%');
        }

        // Update dashboard with new data
        function updateDashboard(data) {
            // Update metric values
            document.getElementById('soilTempValue').textContent = data.soil_temp_c.toFixed(1);
            document.getElementById('soilMoistureValue').textContent = data.soil_moist_pct.toFixed(1);
            document.getElementById('ambientTempValue').textContent = data.ambient_temp_c.toFixed(1);
            document.getElementById('ambientHumidityValue').textContent = data.ambient_humidity_pct.toFixed(1);

            // Update trend indicators with real calculated values
            updateTrendIndicators(data);

            // Update status indicators
            updateStatusIndicators(data);

            // Update trends chart
            updateTrendsChart(data);

            // Update soil health chart with calculated values
            updateSoilHealthChart(data);

            // Store current data as previous for next comparison
            previousSensorData = { ...data };
        }

        // Update status indicators based on values
        function updateStatusIndicators(data) {
            // Soil Temperature Status
            const soilTempStatus = document.getElementById('soilTempStatus');
            const soilTempValue = data.soil_temp_c;
            if (soilTempValue >= 20 && soilTempValue <= 28) {
                soilTempStatus.textContent = 'Optimal';
                soilTempStatus.className = 'status-indicator optimal';
            } else if (soilTempValue < 15 || soilTempValue > 35) {
                soilTempStatus.textContent = 'Critical';
                soilTempStatus.className = 'status-indicator critical';
            } else {
                soilTempStatus.textContent = 'Warning';
                soilTempStatus.className = 'status-indicator warning';
            }

            // Soil Moisture Status
            const soilMoistureStatus = document.getElementById('soilMoistureStatus');
            const soilMoistureValue = data.soil_moist_pct;
            if (soilMoistureValue >= 40 && soilMoistureValue <= 60) {
                soilMoistureStatus.textContent = 'Optimal';
                soilMoistureStatus.className = 'status-indicator optimal';
            } else if (soilMoistureValue < 30 || soilMoistureValue > 70) {
                soilMoistureStatus.textContent = 'Critical';
                soilMoistureStatus.className = 'status-indicator critical';
            } else {
                soilMoistureStatus.textContent = soilMoistureValue < 40 ? 'Low' : 'High';
                soilMoistureStatus.className = 'status-indicator warning';
            }

            // Ambient Temperature Status
            const ambientTempStatus = document.getElementById('ambientTempStatus');
            const ambientTempValue = data.ambient_temp_c;
            if (ambientTempValue >= 15 && ambientTempValue <= 30) {
                ambientTempStatus.textContent = 'Normal';
                ambientTempStatus.className = 'status-indicator optimal';
            } else {
                ambientTempStatus.textContent = ambientTempValue < 15 ? 'Cold' : 'Hot';
                ambientTempStatus.className = 'status-indicator warning';
            }

            // Ambient Humidity Status
            const ambientHumidityStatus = document.getElementById('ambientHumidityStatus');
            const ambientHumidityValue = data.ambient_humidity_pct;
            if (ambientHumidityValue >= 40 && ambientHumidityValue <= 70) {
                ambientHumidityStatus.textContent = 'Optimal';
                ambientHumidityStatus.className = 'status-indicator optimal';
            } else {
                ambientHumidityStatus.textContent = ambientHumidityValue < 40 ? 'Dry' : 'Humid';
                ambientHumidityStatus.className = 'status-indicator warning';
            }
        }

        // Update trends chart with new data point
        function updateTrendsChart(newData) {
            const now = new Date();
            const timeLabel = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });

            // Add new data point
            trendsChart.data.labels.push(timeLabel);
            trendsChart.data.datasets[0].data.push(newData.soil_temp_c);
            trendsChart.data.datasets[1].data.push(newData.soil_moist_pct);

            // Keep only last 24 data points
            if (trendsChart.data.labels.length > 24) {
                trendsChart.data.labels.shift();
                trendsChart.data.datasets[0].data.shift();
                trendsChart.data.datasets[1].data.shift();
            }

            trendsChart.update();
        }

        // Calculate and update soil health chart with real data
        function updateSoilHealthChart(data) {
            // Calculate health scores based on real sensor data
            const temperatureScore = calculateTemperatureScore(data.soil_temp_c);
            const moistureScore = calculateMoistureScore(data.soil_moist_pct);
            const phScore = calculatePhScore(data); // Estimated based on other factors
            const nutrientsScore = calculateNutrientsScore(data); // Estimated
            const aerationScore = calculateAerationScore(data); // Estimated
            const drainageScore = calculateDrainageScore(data); // Estimated

            // Update chart data
            soilHealthChart.data.datasets[0].data = [
                temperatureScore,
                moistureScore,
                phScore,
                nutrientsScore,
                aerationScore,
                drainageScore
            ];

            soilHealthChart.update();
        }

        // Calculate temperature health score (0-100)
        function calculateTemperatureScore(temp) {
            // Optimal soil temperature range: 15-25¬∞C for most crops
            if (temp >= 18 && temp <= 25) return 100; // Optimal
            if (temp >= 15 && temp <= 30) return 80; // Good
            if (temp >= 10 && temp <= 35) return 60; // Acceptable
            return 30; // Poor
        }

        // Calculate moisture health score (0-100)
        function calculateMoistureScore(moisture) {
            // Optimal soil moisture range: 40-60%
            if (moisture >= 45 && moisture <= 55) return 100; // Optimal
            if (moisture >= 40 && moisture <= 60) return 90; // Very good
            if (moisture >= 35 && moisture <= 65) return 75; // Good
            if (moisture >= 30 && moisture <= 70) return 60; // Acceptable
            if (moisture >= 20 && moisture <= 80) return 40; // Poor
            return 20; // Critical
        }

        // Calculate pH health score (estimated based on temperature and moisture)
        function calculatePhScore(data) {
            // Estimate pH based on temperature and moisture patterns
            // This is a simplified estimation - in real systems you'd have pH sensors
            const temp = data.soil_temp_c;
            const moisture = data.soil_moist_pct;

            // Neutral pH (6.5-7.5) is optimal for most crops
            // Estimate based on environmental conditions
            let phEstimate = 7.0; // Assume neutral as baseline

            // Temperature affects microbial activity which influences pH
            if (temp > 25) phEstimate -= 0.2; // Warmer soils tend to be more alkaline
            else if (temp < 18) phEstimate += 0.1; // Cooler soils tend to be more acidic

            // Moisture affects leaching and pH balance
            if (moisture > 60) phEstimate -= 0.1; // Wet soils tend to be more acidic
            else if (moisture < 40) phEstimate += 0.1; // Dry soils tend to be more alkaline

            // Convert pH to health score (optimal range 6.0-8.0)
            if (phEstimate >= 6.5 && phEstimate <= 7.5) return 100;
            if (phEstimate >= 6.0 && phEstimate <= 8.0) return 85;
            if (phEstimate >= 5.5 && phEstimate <= 8.5) return 70;
            return 50;
        }

        // Calculate nutrients health score (estimated)
        function calculateNutrientsScore(data) {
            // Estimate nutrient levels based on moisture and temperature
            // Higher moisture generally indicates better nutrient availability
            // Optimal temperature supports better nutrient uptake
            const moisture = data.soil_moist_pct;
            const temp = data.soil_temp_c;

            let nutrientScore = 70; // Baseline

            // Moisture affects nutrient availability
            if (moisture >= 40 && moisture <= 60) nutrientScore += 15;
            else if (moisture >= 30 && moisture <= 70) nutrientScore += 10;
            else nutrientScore -= 10;

            // Temperature affects microbial activity and nutrient cycling
            if (temp >= 18 && temp <= 25) nutrientScore += 10;
            else if (temp >= 15 && temp <= 30) nutrientScore += 5;

            return Math.max(30, Math.min(100, nutrientScore));
        }

        // Calculate aeration health score (estimated)
        function calculateAerationScore(data) {
            // Estimate soil aeration based on moisture levels
            // Too much moisture reduces aeration, too little may indicate compaction
            const moisture = data.soil_moist_pct;

            if (moisture >= 40 && moisture <= 60) return 90; // Good aeration
            if (moisture >= 35 && moisture <= 65) return 80;
            if (moisture >= 30 && moisture <= 70) return 70;
            if (moisture >= 20 && moisture <= 80) return 60;
            return 40; // Poor aeration
        }

        // Calculate drainage health score (estimated)
        function calculateDrainageScore(data) {
            // Estimate drainage based on moisture stability and temperature
            // Good drainage prevents waterlogging while retaining moisture
            const moisture = data.soil_moist_pct;
            const temp = data.soil_temp_c;

            let drainageScore = 75; // Baseline

            // Optimal moisture range indicates good drainage
            if (moisture >= 40 && moisture <= 60) drainageScore += 15;
            else if (moisture >= 30 && moisture <= 70) drainageScore += 5;
            else drainageScore -= 10;

            // Temperature affects evaporation and drainage patterns
            if (temp >= 18 && temp <= 25) drainageScore += 5;

            return Math.max(40, Math.min(100, drainageScore));
        }

        // Refresh data manually
        function refreshData() {
            if (currentField) {
                loadFieldData(currentField);
            } else {
                loadRealData();
            }
            showNotification('Data refreshed successfully', 'success');
        }


    </script>

    <script src="script.js"></script>
</body>

</html>
